

# Исправление сбоев при генерации изображений

## Проблема

Анализ базы данных и логов выявил несколько критических проблем:

1. **72 задания навсегда зависли** в статусе "processing" — пользователи видят бесконечную загрузку
2. **Функция очистки зависших заданий никогда не запускается** — cron-задача не была настроена
3. **33 из зависших заданий не имеют `started_at`** — функция очистки их не видит, потому что ищет только по этому полю
4. **~5% задач падают из-за ошибок Google API** (503, 400, таймауты) — это нормально, но восстановление можно улучшить

## Что будет сделано

### 1. Настройка автоматической очистки (cron-задача)

Добавим задачу в планировщик `pg_cron`, которая каждые 5 минут вызывает функцию `cleanup-stale-jobs`. Сейчас эта функция существует, но никогда не запускается — это главная причина зависаний.

### 2. Исправление функции очистки

Сейчас функция `cleanup-stale-jobs` ищет зависшие задания только по полю `started_at`. Но 33 задания зависли ещё до того, как это поле заполнилось. Исправим логику — будем также проверять `created_at` как запасной вариант.

### 3. Гарантированная установка `started_at`

В функции `process-generation-tasks-banana` перенесём установку `started_at` на самое начало обработки, чтобы задания не "терялись" для очистки.

### 4. Разовая очистка 72 зависших заданий

Пометим все текущие зависшие задания как неуспешные и вернём токены пострадавшим пользователям.

## Ожидаемый результат

- **Сразу**: 72 зависших задания будут закрыты, токены возвращены пользователям
- **В дальнейшем**: зависшие задания будут автоматически обнаруживаться и закрываться каждые 5 минут
- **Ошибки Google API** (~5%) — это норма, они обрабатываются повторными попытками и возвратом токенов

---

## Технические детали

### Файлы для изменения

| Файл | Что меняется |
|------|-------------|
| `supabase/functions/cleanup-stale-jobs/index.ts` | Добавляем проверку `created_at` как fallback для `started_at` |
| `supabase/functions/process-generation-tasks-banana/index.ts` | Переносим установку `started_at` в начало обработки |
| SQL-миграция | Создание cron-задачи + разовая очистка 72 зависших заданий |

### SQL-миграция: cron-задача и очистка

Настройка автозапуска функции очистки каждые 5 минут через `pg_cron` + `pg_net`. Также разовое обновление всех зависших заданий: пометка задач как `failed`, закрытие заданий с сообщением об ошибке.

Возврат токенов за зависшие задания нужно будет обработать отдельно, так как у каждого задания своя стоимость и пользователь.

### Изменения в `cleanup-stale-jobs`

Текущая логика:
```text
Ищем задания WHERE status='processing' AND started_at < порог
```

Новая логика:
```text
Ищем задания WHERE status='processing' 
  AND (started_at < порог ИЛИ (started_at IS NULL AND created_at < порог))
```

### Изменения в `process-generation-tasks-banana`

Установка `started_at = now()` сразу при получении запроса, до начала любой асинхронной работы — чтобы задание всегда было видно функции очистки.

