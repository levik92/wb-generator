

# План: Улучшения видеообложек, перегенерация, история и админка

## Обзор

Реализация 7 направлений: исправление багов с историей видео, функция перегенерации (2 токена), таймер 2 минуты, промо-блок, бета-уведомление, подсказки, отображение видео в прайсах и админке.

---

## 1. Исправление критического бага: колонка в БД

**Проблема:** В таблице `video_generation_jobs` колонка называется `result_video_url`, но edge function `check-video-status` записывает в `video_url` (строки 112, 177). Из-за этого видео не сохраняется в БД и не отображается в истории.

**Исправление:**
- В `check-video-status/index.ts`: заменить `video_url` на `result_video_url` в обоих `.update()` вызовах (строки 112 и 177)
- В `check-video-status/index.ts`: в ответе для уже завершённых задач (строка 112) тоже читать `result_video_url`

---

## 2. Удаление видео из истории

**Проблема:** Кнопка удаления скрыта для видео (строка 715 History.tsx: `generation_type !== 'video'`).

**Исправление:**
- Убрать условие `generation_type !== 'video'`
- Добавить отдельный обработчик удаления для видео: `supabase.from('video_generation_jobs').delete().eq('id', id).eq('user_id', profile.id)`
- Добавить RLS политику DELETE для `video_generation_jobs` (пользователь может удалять свои записи)

---

## 3. Перегенерация видео (2 токена)

### 3.1 Запись в generation_pricing
- Добавить строку: `price_type = 'video_regeneration'`, `tokens_cost = 2`, `description = 'Перегенерация видеообложки'`
- Эта строка автоматически появится в AdminPricing и будет редактируемой

### 3.2 Обновить useGenerationPricing.ts
- Добавить `'video_regeneration'` в тип `PriceType`

### 3.3 Новая edge function: `regenerate-video-job`
- Принимает `original_job_id` и опциональный `user_prompt`
- Читает `product_image_url` из оригинальной задачи (фото не меняется)
- Использует стоимость `video_regeneration` из `generation_pricing` (2 токена)
- Далее идентично `create-video-job`: проверка баланса, списание, вызов Kling API, сохранение новой задачи

### 3.4 Обновить config.toml
- Добавить `[functions.regenerate-video-job]` с `verify_jwt = false`

### 3.5 UI блок перегенерации (VideoCovers.tsx)
- Под результатом видео добавить блок "Не нравится результат?"
- Текст: можно перегенерировать за 2 токена
- Поле описания (опционально, можно переписать пожелания)
- Кнопка "Перегенерировать" с бейджем стоимости
- При нажатии: вызов `regenerate-video-job`, запуск polling

---

## 4. Таймер: 4 минуты -> 2 минуты

**VideoCovers.tsx:**
- `ESTIMATED_TIME_SECONDS` = `2 * 60` вместо `4 * 60`
- Тексты "~4 минуты" заменить на "~2 минуты"

---

## 5. Подсказки и уведомления

### 5.1 Под кнопкой генерации
- Серый текст: "Видео генерирует нейросеть. Внимательно относитесь к описанию пожеланий. Если результат не устраивает, видео можно перегенерировать в 5 раз дешевле."

### 5.2 Бета-уведомление
- Alert-компонент вверху страницы с иконкой Info:
  "Функция находится в бета-доступе. Качество генерации будет улучшаться и дорабатываться. В случае сбоев или вопросов пишите в поддержку."

---

## 6. Промо/CTA блок

- Карточка после основной формы генерации (аналогично блоку в изображениях)
- Заголовок: "Посмотрите, какие видеообложки можно создавать"
- Кнопка "Пополнить баланс" -- переход на вкладку тарифов
- Кнопка "Посмотреть примеры" -- ссылка на лендинг видео (в новой вкладке)

---

## 7. Стоимость видео в прайсах и админке

### Pricing.tsx (страница тарифов)
- Видео уже отображается в прайсах (строка 171-173). Нужно добавить строку с количеством видео: `Math.floor(tokens / videoPrice)` видео

### AdminPricing.tsx
- Строка `video_generation` уже автоматически подтягивается из `generation_pricing`
- После добавления `video_regeneration` она тоже появится автоматически -- **никаких изменений в AdminPricing не нужно**, всё работает через общий цикл `generationPrices.map()`

---

## 8. Автоочистка через 30 дней

- Миграция: обновить функцию `cleanup_old_generations()` (или создать новую), чтобы также удалять из `video_generation_jobs` записи старше 30 дней

---

## Технические детали

### Новые файлы
| Файл | Назначение |
|------|-----------|
| `supabase/functions/regenerate-video-job/index.ts` | Edge function перегенерации видео |

### Изменяемые файлы
| Файл | Изменения |
|------|-----------|
| `supabase/functions/check-video-status/index.ts` | Исправить `video_url` -> `result_video_url` |
| `src/components/dashboard/VideoCovers.tsx` | Таймер 2 мин, подсказки, бета-алерт, блок перегенерации, CTA-блок |
| `src/components/dashboard/History.tsx` | Разрешить удаление видео, обработчик удаления для video_generation_jobs |
| `src/hooks/useGenerationPricing.ts` | Добавить `video_regeneration` в PriceType |
| `src/components/dashboard/Pricing.tsx` | Добавить строку "X видеообложек" в расчёт тарифов |
| `supabase/config.toml` | Добавить `regenerate-video-job` |

### Миграция БД
- RLS политика DELETE для `video_generation_jobs`: пользователь может удалять свои записи
- Обновление функции автоочистки для включения `video_generation_jobs`

### Вставка данных (не миграция)
- INSERT в `generation_pricing`: `video_regeneration`, 2 токена, "Перегенерация видеообложки"

### Порядок реализации
1. Исправить баг с колонкой `result_video_url` в `check-video-status`
2. Миграция: RLS DELETE + автоочистка
3. Вставить строку `video_regeneration` в `generation_pricing`
4. Создать `regenerate-video-job` edge function
5. Обновить `VideoCovers.tsx` (таймер, подсказки, перегенерация, бета, CTA)
6. Обновить `History.tsx` (удаление видео)
7. Обновить `useGenerationPricing.ts` и `Pricing.tsx`
8. Обновить `config.toml`
9. Задеплоить и протестировать

